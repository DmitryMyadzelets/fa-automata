!function(){function e(a){var b=[0,0],c=[0,0],d=[0,0],e=function(){return[b[0],b[1]]};return e.start=function(){d[0]=d3.event.pageX,d[1]=d3.event.pageY},e.mouse=function(){return d3.mouse(a[0][0])},e.to_mouse=function(){c[0]=d3.event.pageX-d[0],c[1]=d3.event.pageY-d[1],d[0]=d3.event.pageX,d[1]=d3.event.pageY,b[0]+=c[0],b[1]+=c[1],a.attr("transform","translate("+b[0]+","+b[1]+")")},e}function f(){return{nodes:[],edges:[]}}function g(a){return this.target===a.source&&this.source===a.target}function h(a){a.type=a.source===a.target?2:this._graph.edges.filter(g,a).length>0?1:0}function i(a,b){function k(){d.controller.context(d,"plane").event.apply(this,arguments)}var d=this,f=d3.select(a||"body"),g=500,h=300,j=f.append("svg").attr("width",g).attr("height",h).on("contextmenu",function(){d3.event.preventDefault()});this.selection_rectangle=function(){return i.prototype.selection_rectangle.context(j)},this.select=function(){return i.prototype.select.context(d,j)},this.node_handler=function(){d.controller.context(d,"node").event.apply(this,arguments)},this.edge_handler=function(){d.controller.context(d,"edge").event.apply(this,arguments)},j.on("mousedown",k).on("mouseup",k).on("mousemove",k).on("dblclick",k).on("dragstart",function(){d3.event.preventDefault()}),j=j.append("g"),j.append("svg:defs").append("svg:marker").attr("id","marker-arrow").attr("orient","auto").attr("markerWidth",6).attr("markerHeight",6).attr("refX",6).attr("refY",3).append("svg:path").attr("d","M0,0 L6,3 L0,6"),this.force=d3.layout.force().charge(-800).linkDistance(150).chargeDistance(450).size([g,h]).on("tick",function(){d.node.attr("transform",c.get_node_transformation),d.link.selectAll("path").attr("d",c.get_link_transformation)}),this.node=j.append("g").attr("class","nodes").selectAll("g"),this.link=j.append("g").attr("class","links").selectAll("g"),this.pan=e(j),this.graph(b)}var a={version:"1.0.0"},b={length:function(a){return Math.sqrt(a[0]*a[0]+a[1]*a[1])},normalize:function(a,b){var c=this.length(a);return c=1/c,b[0]=a[0]*c,b[1]=a[1]*c,b},orthogonal:function(a,b){return b[0]=a[1],b[1]=-a[0],b},scale:function(a,b,c){return c[0]=a[0]*b,c[1]=a[1]*b,c},add:function(a,b,c){return c[0]=a[0]+b[0],c[1]=a[1]+b[1],c},subtract:function(a,b,c){return c[0]=a[0]-b[0],c[1]=a[1]-b[1],c},copy:function(a,b){return b[0]=a[0],b[1]=a[1],b}},c={};c.make_edge=function(){var a=[0,0],c=16,d=[0,0],e=function(){var a=Math.PI/3,b=Math.PI/12;return{DX1:c*Math.cos(a),DY1:c*Math.sin(a),DX2:4*c*Math.cos(a),DY2:4*c*Math.sin(a),DX3:4*c*Math.cos(b),DY3:4*c*Math.sin(b),DX4:c*Math.cos(b),DY4:c*Math.sin(b),NX:Math.cos(a-Math.PI/24),NY:Math.sin(a-Math.PI/24)}}();return{stright:function(e,f){b.subtract(f,e,a),b.normalize(a,d),b.scale(d,c,a),b.add(e,a,e),b.subtract(f,a,f)},drag:function(e,f,g){b.subtract(f,e,a),b.normalize(a,d),b.scale(d,c,a),b.add(e,a,e),g&&b.subtract(f,a,f)},curve:function(e,f,g){b.subtract(f,e,a),b.normalize(a,d),g[0]=.5*(e[0]+f[0])+2*d[1]*c,g[1]=.5*(e[1]+f[1])-2*d[0]*c,b.copy(g,a),this.stright(e,a),b.copy(g,a),this.stright(f,a)},loop:function(c,d,f,g){b.copy(c,a),c[0]=a[0]+e.DX1,c[1]=a[1]-e.DY1,f[0]=a[0]+e.DX2,f[1]=a[1]-e.DY2,g[0]=a[0]+e.DX3,g[1]=a[1]-e.DY3,d[0]=a[0]+e.DX4,d[1]=a[1]-e.DY4}}}(),c.get_link_transformation=function(){var a=[0,0],b=[0,0],d=[0,0],e=[0,0];return function(f){switch(a[0]=f.source.x,a[1]=f.source.y,b[0]=f.target.x,b[1]=f.target.y,f.type){case 1:c.make_edge.curve(a,b,d);break;case 2:c.make_edge.loop(a,b,d,e);break;default:c.make_edge.stright(a,b)}switch(f.x1=a[0],f.y1=a[1],f.x2=b[0],f.y2=b[1],f.type){case 1:return"M"+a[0]+","+a[1]+"Q"+d[0]+","+d[1]+","+b[0]+","+b[1];case 2:return"M"+a[0]+","+a[1]+"C"+d[0]+","+d[1]+","+e[0]+","+e[1]+","+b[0]+","+b[1];default:return"M"+a[0]+","+a[1]+"L"+b[0]+","+b[1]}}}(),c.get_node_transformation=function(a){return a.x=a.x||0,a.y=a.y||0,"translate("+a.x+","+a.y+")"},c.add_node=function(a,b){a.append("g").attr("transform",this.get_node_transformation).append("circle").attr("r",16).on("mousedown",b).on("mouseup",b).on("mouseover",b).on("mouseout",b).on("dblclick",b)},c.add_link=function(a,b){var c=a.append("g").on("mousedown",b).on("mouseup",b).on("mouseover",b).on("dblclick",b);return c.append("path").attr("class","link").attr("marker-end","url(#marker-arrow)"),c.append("path").attr("class","catchlink"),c},function(){var e,a=[0,0],c=[0,0],d={},f=!1,g=!1;return{show:function(a){d.source=a,e=add_link(container).select("path.link"),f=!0},to_point:function(a){b.copy(a,c),g=!1,this.update()},to_node:function(a){d.target=a,g=!0,this.update()},update:function(){f&&(a[0]=d.source.x,a[1]=d.source.y,g?(h(d),e.attr("d",get_link_path(d))):(make_edge.drag(a,c),e.attr("d","M"+a[0]+","+a[1]+"L"+c[0]+","+c[1])))},hide:function(){e.remove(),f=!1}}}(),i.prototype.graph=function(a){return arguments.length>0&&(this._graph=null,this._graph=a||f(),this.force.nodes(this._graph.nodes).links(this._graph.edges),this.update()),this._graph},i.prototype.update=function(){var a=this._graph;this.node=this.node.data(a.nodes),this.node.enter().call(c.add_node,this.node_handler),this.node.exit().remove(),this.link=this.link.data(a.edges),this.link.enter().call(c.add_link,this.edge_handler),this.link.exit().remove();var b=this;this.link.each(function(){h.apply(b,arguments)}),this.force.start()},i.prototype.selection_rectangle=function(){var a,b,c,d,e,f,h,i,g={},j=function(){var e=[a,b,c,d];return a>c&&(e[0]=c,e[2]=a),b>d&&(e[1]=d,e[3]=b),e};return j.show=function(c){a=c[0],b=c[1],h=i.append("rect").attr({x:a,y:b,"class":"selection"})},j.update=function(i){c=i[0],d=i[1],e=c-a,f=d-b,g.x=a,g.y=b,0>e&&(e=-e,g.x=c),0>f&&(f=-f,g.y=d),g.width=e,g.height=f,h.attr(g)},j.hide=function(){h.remove()},j.context=function(a){return i=a,this},j}(),i.prototype.select=function(){function c(a,b,c){return a>c[0]&&a<c[2]&&b>c[1]&&b<c[3]}var d,e,a=[],b=[];return{context:function(a,b){return d=a,e=b,this},node:function(b){var c=d.node.filter(function(a){return a===b}),e=a.indexOf(b);0>e?(b.selected=!0,a.push(b)):(b.selected=!1,a.splice(e,1)),c.classed("selected",b.selected)},link:function(a){var c=d.link.select(".link").filter(function(b){return b===a}),e=b.indexOf(a);0>e?(a.selected=!0,b.push(a)):(a.selected=!1,b.splice(e,1)),c.classed("selected",a.selected)},nothing:function(){a.length=0,b.length=0,e=e||d3,e.selectAll(".selected").classed("selected",!1).each(function(a){a.selected=!1})},by_rectangle:function(a){var b=d.pan();a[0]-=b[0],a[2]-=b[0],a[1]-=b[1],a[3]-=b[1],d.node.each(function(b){c(b.x,b.y,a)&&d.select().node(b)}),d.link.each(function(b){c(b.x1,b.y1,a)&&c(b.x2,b.y2,a)&&d.select().link(b)})}}}(),i.prototype.controller=function(){var a,b,c,d,e,f,g,h,i={init:function(e){switch(b){case"plane":switch(c){case"mousemove":break;case"dblclick":d=a.pan.mouse();var h={x:d[0],y:d[1]};a.graph().nodes.push(h),a.update(),d3.event.ctrlKey||a.select().nothing(),a.select().node(h);break;case"mousedown":if(d3.event.shiftKey){a.pan.start(),g=i.move_graph;break}d=d3.mouse(this),g=i.wait_for_selection}break;case"node":switch(c){case"mousedown":console.log(this,arguments,e),f=e,g=i.select_or_drag}}},select_or_drag:function(){switch(b){case"plane":switch(c){case"mousemove":d3.event.shiftKey&&(d=a.pan.mouse(),f.selected||a.select().node(f))}break;case"node":switch(c){case"mouseout":if(d3.event.shiftKey)break;g=i.drag_link;break;case"mouseup":d3.event.ctrlKey||a.select().nothing(),a.select().node(f),g=i.init}}},wait_for_selection:function(){switch(c){case"mousemove":d3.event.ctrlKey||a.select().nothing(),e=a.selection_rectangle(),e.show(d),d=d3.mouse(this),g=i.selection;break;case"mouseup":d3.event.ctrlKey||a.select().nothing(),g=i.init;break;default:g=i.init}},selection:function(){switch(console.log(c),c){case"mousemove":e.update(d3.mouse(this));break;case"mouseup":a.select().by_rectangle(e()),e.hide(),g=i.init}},move_graph:function(){switch(c){case"mousemove":d3.event.shiftKey||(g=i.init),a.pan.to_mouse();break;case"mouseup":g=i.init}}};g=i.init;var j;for(j in i)i.hasOwnProperty(j)&&(i[j]._name=j);return{event:function(){a&&(b=b||d3.event.target.nodeName,c=d3.event.type,h=g,g.apply(this,arguments),a=null,b=null,d3.event.stopPropagation(),h!==g&&console.log("transition:",h._name+" -> "+g._name))},context:function(c,d){return a=c,b=d,this}}}(),a.view=function(a,b){return new i(a,b)},this.jA=this.jA||{},this.jA.editor=a}(window);