(function(){var c,g,s,u,z,a,q,E,e,d,i,h,w,k,B,D,A,v,p,n,f,o,C,t,j,b,m,l;m=l=0;u=null;g=null;this.graph=faxy.create();j=null;this.pack=function(F,G){return((F&65535)<<16)|(G&65535);
};this.unpack=function(x){return[(x>>16)&65535,x&65535];};s=function(I){var K,y,H,x,G,F,J;x=I.length;G=[];F=0;H=0;while(H<x){K=I.charCodeAt(H);switch(F){case 0:if(K!==32&&K!==44){J=H;
y=H;F=1;}break;case 1:if(K===44){G.push(I.substr(J,y-J+1));F=0;}else{if(K!==32){y=H;}}}if(++H===x&&1===F){G.push(I.substr(J,y-J+1));}}return G;};v=function(F){var x,y;
if(!($&&$.jStorage&&$.jStorage.storageAvailable()&&JSON)){return false;}x=(y=JSON.parse($.jStorage.get("graph")))!=null?y:null;return x;};C=function(x){if(!($&&$.jStorage&&$.jStorage.storageAvailable())){return false;
}$.jStorage.set("graph",JSON.stringify(x));return null;};q={dx:0,dy:0};p=function(N,M,J){var H,F,L,G,K,I;G=N.nodes.x;for(H=F=0,L=G.length;F<L;H=++F){K=G[H];
I=N.nodes.y[H];q.dx=M-K;q.dy=J-I;if((q.dx*q.dx)+(q.dy*q.dy)<(r*r)){return H;}}return -1;};z=function(S,Q,N){var J,K,L,R,G,F,P,M,H,O,I;I=S.edges.$;for(L=H=0,O=I.length;
H<O;L=++H){J=I[L];R=20;K=10;G=J.label[0][0]-R;P=J.label[0][1]-K;F=J.label[0][0]+R;M=J.label[0][1]+K;if(Q>G&&Q<F&&N>P&&N<M){return L;}}return -1;};o=function(x,y){if(x!==g.width||y!==g.height){g.width=x;
g.height=y;u.lineWidth=1.2;u.font="0.8em Verdana 'Courier New'";draw.automaton(u,graph);}return null;};t=f=0;n=-1;D=false;w={node_ix:0,x:0,y:0};a=-1;c=function(T,V){var F,P,O,U,R,Q,S,J,I,W,Y,N,M,L,K,H,G,y,x,Z,X;
switch(f=t){case 0:if(1===T){N=B(V),m=N[0],l=N[1];n=p(graph,m,l);if(n>=0){if(!V.shiftKey){w.node_ix=n;t=2;}else{w.x=graph.nodes.x[n];w.y=graph.nodes.y[n];
t=1;}}else{if(z(graph,m,l)>=0){null;}else{if(V.shiftKey){w.x=m;w.y=l;t=4;}else{w.x=m;w.y=l;t=5;}}}}if(4===T){M=B(V),m=M[0],l=M[1];a=z(graph,m,l);if(a>=0){if(graph.edges.events[a]!=null){S=[];
L=graph.edges.events[a];for(J=0,W=L.length;J<W;J++){U=L[J];S.push(graph.events[U]);}R=S.join(", ");}else{R="";}j.show(graph.edges.$[a].label[0][0]-20,graph.edges.$[a].label[0][1]-10,R);
t=6;}}break;case 1:switch(T){case 2:K=B(V),m=K[0],l=K[1];if((m-=q.dx)<0){m=0;}if((l-=q.dy)<0){l=0;}editor.nodes.move(graph,n,m,l);break;case 3:editor.nodes.move2(graph,n,w.x,w.y,m,l);
D=true;t=0;break;default:graph.nodes.x[n]=w.x;graph.nodes.y[n]=w.y;t=0;}u.clearRect(0,0,g.width,g.height);draw.automaton(u,graph);break;case 2:switch(T){case 2:H=B(V),m=H[0],l=H[1];
n=p(graph,m,l);if(n!==w.node_ix){w.x=graph.nodes.x[w.node_ix];w.y=graph.nodes.y[w.node_ix];t=3;}break;default:t=0;}break;case 3:G=B(V),m=G[0],l=G[1];n=p(graph,m,l);
switch(T){case 2:u.clearRect(0,0,g.width,g.height);draw.automaton(u,graph);draw.fake_edge(u,faxy.get_fake_edge(graph,w.node_ix,n,m,l));break;case 3:if(n<0){editor.commands.start_transaction();
n=editor.nodes.add(graph,m,l);editor.edges.add(graph,w.node_ix,n);editor.commands.stop_transaction();}else{editor.edges.add(graph,w.node_ix,n);}D=true;
u.clearRect(0,0,g.width,g.height);draw.automaton(u,graph);t=0;break;default:u.clearRect(0,0,g.width,g.height);draw.automaton(u,graph);t=0;}break;case 4:switch(T){case 2:y=B(V),m=y[0],l=y[1];
u.save();u.clearRect(0,0,g.width,g.height);u.translate(m-w.x,l-w.y);draw.automaton(u,graph);u.restore();break;case 3:x=B(V),m=x[0],l=x[1];u.clearRect(0,0,g.width,g.height);
draw.automaton(u,graph);D=true;t=0;break;default:u.clearRect(0,0,g.width,g.height);draw.automaton(u,graph);t=0;}break;case 5:switch(T){case 3:Z=B(V),m=Z[0],l=Z[1];
editor.nodes.add(graph,m,l);u.clearRect(0,0,g.width,g.height);draw.automaton(u,graph);D=true;t=0;break;case 2:X=B(V),m=X[0],l=X[1];P=m-w.x;O=l-w.y;P*=P;
O*=O;if((P>4)||(O>4)){t=0;}break;default:t=0;}break;case 6:switch(T){case 5:if(a>-1){F=s(j.text());if(graph.edges.events[a]!=null){graph.edges.events[a].length=0;
}for(I=0,Y=F.length;I<Y;I++){Q=F[I];U=automata.events.add(graph,Q);automata.edges.events.add(graph,a,U);}u.clearRect(0,0,g.width,g.height);draw.automaton(u,graph);
D=true;}g.focus();t=0;break;case 6:g.focus();t=0;}}if(f!==t){console.log(T+": "+f+"->"+t);if(0===t){if(D){C(graph);D=false;}}if(6===f){a=-1;}}return null;
};k=function(x,y){if(window.getComputedStyle){return window.getComputedStyle(x)[y];}else{if(x.currentStyle){return x.currentStyle[y];}}return null;};A=function(x){var I,H,G,y,F;
I=document.getElementById("container");g=document.getElementById(x);g.focus();u=g.getContext("2d");u.lineWidth=1.2;u.font="0.8em Verdana 'Courier New'";
if((F=k(g,"backgroundColor"))){draw.backgroundColor=F;}g.addEventListener("mousemove",i,false);g.addEventListener("mousedown",d,false);g.addEventListener("mouseup",h,false);
g.addEventListener("keydown",e,false);g.addEventListener("dblclick",E,false);g.addEventListener("dragstart",function(J){J.preventDefault();return false;
});g.onselectstart=function(){return false;};o(I.offsetWidth,I.offsetHeight);window.onresize=function(J){o(I.offsetWidth,I.offsetHeight);return null;};
H=v(graph);if(H===null){console.log("default");G=editor.nodes.add(graph,-50+g.width/2,g.height/2);y=editor.nodes.add(graph,50+g.width/2,g.height/2);editor.edges.add(graph,G,y);
editor.edges.add(graph,y,y);}else{window.graph=H;}draw.automaton(u,graph);j=new textarea;j.attach("label_editor",(function(J){return c(5,J);}),(function(J){return c(6,J);
}));return null;};B=function(x){var y;y=g.getBoundingClientRect();return[x.clientX-y.left,x.clientY-y.top];};d=function(x){c(1,x);return null;};i=function(x){c(2,x);
return null;};h=function(x){c(3,x);return null;};E=function(x){c(4,x);return null;};e=function(x){if(x.ctrlKey){switch(x.keyCode){case 89:editor.redo();
u.clearRect(0,0,g.width,g.height);draw.automaton(u,graph);C(graph);break;case 90:editor.undo();u.clearRect(0,0,g.width,g.height);draw.automaton(u,graph);
C(graph);}}else{switch(x.keyCode){case 46:editor.nodes.del(graph,graph.nodes.length-1);u.clearRect(0,0,g.width,g.height);draw.automaton(u,graph);C(graph);
break;case 81:editor.edges.del(graph,graph.edges.length-1);u.clearRect(0,0,g.width,g.height);draw.automaton(u,graph);break;case 74:console.log(JSON.stringify(graph));
break;default:null;}}return null;};window.onload=function(){A("myCanvas");return null;};(b=function(){console.log(".");return setTimeout(b,1000);})();this.foo=function(){g.width=1000;
return null;};}).call(this);