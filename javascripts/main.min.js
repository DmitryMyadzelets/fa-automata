(function(){var w,d,m,k,u,t,b,f,e,n,q,v,p,o,j,i,c,s,l,a,h,g;h=g=0;m=null;d=null;this.graph=faxy.create();this.pack=function(z,A){return((z&65535)<<16)|(A&65535);
};this.unpack=function(x){return[(x>>16)&65535,x&65535];};o=function(z){var x,y;if(!($&&$.jStorage&&$.jStorage.storageAvailable()&&JSON)){return false;
}x=(y=JSON.parse($.jStorage.get("graph")))!=null?y:{};return z.nodes.length>0;};s=function(x){return false;if(!($&&$.jStorage&&$.jStorage.storageAvailable())){return false;
}return $.jStorage.set("graph",JSON.stringify(x));};k={dx:0,dy:0};j=function(H,G,D){var B,z,F,A,E,C;A=H.nodes.x;for(B=z=0,F=A.length;z<F;B=++z){E=A[B];
C=H.nodes.y[B];k.dx=G-E;k.dy=D-C;if((k.dx*k.dx)+(k.dy*k.dy)<(r*r)){return B;}}return -1;};l=c=0;i=-1;v=false;n={node_ix:0,x:0,y:0};w=function(G,H){var J,I,E,F,D,C,B,A,z,y,x;
switch(c=l){case 0:if(1===G){F=q(H),h=F[0],g=F[1];i=j(graph,h,g);if(i>=0){if(!H.shiftKey){n.node_ix=i;m.clearRect(0,0,d.width,d.height);draw_graph(m,graph);
l=2;}else{n.x=graph.nodes.x[i];n.y=graph.nodes.y[i];l=1;}}else{if(H.shiftKey){n.x=h;n.y=g;l=4;}else{n.x=h;n.y=g;l=5;}}}break;case 1:switch(G){case 2:D=q(H),h=D[0],g=D[1];
if((h-=k.dx)<0){h=0;}if((g-=k.dy)<0){g=0;}editor.nodes.move(graph,i,h,g);break;case 3:editor.nodes.move2(graph,i,n.x,n.y,h,g);v=true;l=0;break;default:graph.nodes.x[i]=n.x;
graph.nodes.y[i]=n.y;l=0;}m.clearRect(0,0,d.width,d.height);draw_graph(m,graph);break;case 2:switch(G){case 2:C=q(H),h=C[0],g=C[1];i=j(graph,h,g);if(i!==n.node_ix){n.x=graph.nodes.x[n.node_ix];
n.y=graph.nodes.y[n.node_ix];l=3;}break;default:l=0;}break;case 3:B=q(H),h=B[0],g=B[1];switch(G){case 2:i=j(graph,h,g);E=i<0;if(!E){h=graph.nodes.x[i];
g=graph.nodes.y[i];}m.clearRect(0,0,d.width,d.height);draw_graph(m,graph);if(i===n.node_ix){draw_loop(m,n.x,n.y);}else{draw_edge(m,n.x,n.y,h,g,E);}break;
case 3:i=j(graph,h,g);if(i<0){editor.commands.start_transaction();i=editor.nodes.add(graph,h,g);editor.edges.add(graph,n.node_ix,i);editor.commands.stop_transaction();
}else{editor.edges.add(graph,n.node_ix,i);}v=true;m.clearRect(0,0,d.width,d.height);draw_graph(m,graph);l=0;break;default:m.clearRect(0,0,d.width,d.height);
draw_graph(m,graph);l=0;}break;case 4:switch(G){case 2:A=q(H),h=A[0],g=A[1];m.save();m.clearRect(0,0,d.width,d.height);m.translate(h-n.x,g-n.y);draw_graph(m,graph);
m.restore();break;case 3:z=q(H),h=z[0],g=z[1];m.clearRect(0,0,d.width,d.height);draw_graph(m,graph);v=true;l=0;break;default:m.clearRect(0,0,d.width,d.height);
draw_graph(m,graph);l=0;}break;case 5:switch(G){case 3:y=q(H),h=y[0],g=y[1];editor.nodes.add(graph,h,g);m.clearRect(0,0,d.width,d.height);draw_graph(m,graph);
v=true;l=0;break;case 2:x=q(H),h=x[0],g=x[1];J=h-n.x;I=g-n.y;J*=J;I*=I;if((J>4)||(I>4)){l=0;}break;default:l=0;}}if(c!==l){console.log(G+": "+c+"->"+l);
if(0===l){if(v){s(graph);v=false;}}}return null;};p=function(){var y,x;d=document.getElementById("editor");d.focus();m=d.getContext("2d");m.fillStyle="gray";
m.lineWidth=1.2;m.strokeStyle="rgba(0,0,255,0.5)";m.font="12pt Tahoma";m.textAlign="left";d.addEventListener("mousedown",b,false);d.addEventListener("mouseup",e,false);
d.addEventListener("mousemove",f,false);d.addEventListener("keypress",u,false);d.addEventListener("keyup",t,false);d.addEventListener("dragstart",function(z){return z.preventDefault();
},false);if(true){y=editor.nodes.add(graph,-50+d.width/2,d.height/2);x=editor.nodes.add(graph,50+d.width/2,d.height/2);editor.edges.add(graph,y,x);editor.edges.add(graph,x,x);
}draw_graph(m,graph);return null;};q=function(x){var y;y=d.getBoundingClientRect();return[x.clientX-y.left,x.clientY-y.top];};window.onload=function(){p();
return null;};b=function(x){w(1,x);return null;};f=function(x){w(2,x);return null;};e=function(x){w(3,x);return null;};u=function(x){if(x.ctrlKey){switch(x.keyCode){case 25:editor.redo();
m.clearRect(0,0,d.width,d.height);draw_graph(m,graph);s(graph);break;case 26:editor.undo();m.clearRect(0,0,d.width,d.height);draw_graph(m,graph);s(graph);
}}return null;};t=function(x){switch(x.keyCode){case 46:editor.nodes.del(graph,graph.nodes.length-1);m.clearRect(0,0,d.width,d.height);draw_graph(m,graph);
s(graph);break;case 81:editor.edges.del(graph,graph.edges.length-1);m.clearRect(0,0,d.width,d.height);draw_graph(m,graph);break;}return null;};(a=function(){console.log(".");
return setTimeout(a,1000);})();}).call(this);