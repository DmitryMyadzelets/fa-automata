(function(){var n,I,K,F,h,u,E,q,H,D,d,j,i,s,z,B,J,A,w,p,o,f,C,t,c,m,l,k,g=[].indexOf||function(v){for(var b=0,a=this.length;b<a;b++){if(b in this&&this[b]===v){return b;
}}return -1;};l=k=0;u=null;h=null;this.graph={nodes:{x:[],y:[]},edges:[],curved:[]};this.pack=function(a,b){return((a&65535)<<16)|(b&65535);};this.unpack=function(a){return[(a>>16)&65535,a&65535];
};w=function(N){var M,L,G,y,x,v,b,a;if(!($&&$.jStorage&&$.jStorage.storageAvailable()&&JSON)){return false;}M=(L=JSON.parse($.jStorage.get("graph")))!=null?L:{};
console.log(M);N.edges=(G=M.edges)!=null?G:[];N.curved=(y=M.curved)!=null?y:[];N.nodes.x=(x=(v=M.nodes)!=null?v.x:void 0)!=null?x:[];N.nodes.y=(b=(a=M.nodes)!=null?a.y:void 0)!=null?b:[];
return N.nodes.x.length>0;};C=function(a){if(!($&&$.jStorage&&$.jStorage.storageAvailable())){return false;}return $.jStorage.set("graph",JSON.stringify(a));
};q={dx:0,dy:0};p=function(P,O,L){var v,a,N,b,M,G;b=P.nodes.x;for(v=a=0,N=b.length;a<N;v=++a){M=b[v];G=P.nodes.y[v];q.dx=O-M;q.dy=L-G;if((q.dx*q.dx)+(q.dy*q.dy)<(r*r)){return v;
}}return -1;};E=function(v,y,N){var a,L,b,M,x,G;for(b=0,M=v.length;b<M;b++){a=v[b];x=unpack(a),L=x[0],G=x[1];if(L===y&&G===N){return true;}}return false;
};t=f=0;o=-1;J=false;z={node_ix:0,x:0,y:0};K=function(O,P){var R,Q,M,N,L,G,y,x,v,b,a;switch(f=t){case 0:if(1===O){N=B(P),l=N[0],k=N[1];o=p(graph,l,k);if(o>=0){if(!P.shiftKey){z.node_ix=o;
u.clearRect(0,0,h.width,h.height);draw_graph(u,graph);t=2;}else{z.x=graph.nodes.x[o];z.y=graph.nodes.y[o];t=1;}}else{if(P.shiftKey){z.x=l;z.y=k;t=4;}else{z.x=l;
z.y=k;t=5;}}}break;case 1:switch(O){case 2:L=B(P),l=L[0],k=L[1];if((l-=q.dx)<0){l=0;}if((k-=q.dy)<0){k=0;}move_node(o,l,k);break;case 3:editor.move_node(o,z.x,z.y,l,k);
J=true;t=0;break;default:graph.nodes.x[o]=z.x;graph.nodes.y[o]=z.y;t=0;}u.clearRect(0,0,h.width,h.height);draw_graph(u,graph);break;case 2:switch(O){case 2:G=B(P),l=G[0],k=G[1];
o=p(graph,l,k);if(o!==z.node_ix){z.x=graph.nodes.x[z.node_ix];z.y=graph.nodes.y[z.node_ix];t=3;}break;default:t=0;}break;case 3:y=B(P),l=y[0],k=y[1];switch(O){case 2:o=p(graph,l,k);
M=o<0;if(!M){l=graph.nodes.x[o];k=graph.nodes.y[o];}u.clearRect(0,0,h.width,h.height);draw_graph(u,graph);if(o===z.node_ix){draw_loop(u,z.x,z.y);}else{draw_edge(u,z.x,z.y,l,k,M);
}break;case 3:o=p(graph,l,k);if(o<0){editor.start_transaction();o=editor.add_node(l,k);editor.add_edge(z.node_ix,o);editor.stop_transaction();}else{if(!E(graph.edges,z.node_ix,o)){editor.add_edge(z.node_ix,o);
}}J=true;u.clearRect(0,0,h.width,h.height);draw_graph(u,graph);t=0;break;default:u.clearRect(0,0,h.width,h.height);draw_graph(u,graph);t=0;}break;case 4:switch(O){case 2:x=B(P),l=x[0],k=x[1];
u.save();u.clearRect(0,0,h.width,h.height);u.translate(l-z.x,k-z.y);draw_graph(u,graph);u.restore();break;case 3:v=B(P),l=v[0],k=v[1];editor.move_graph(z.x,z.y,l,k);
u.clearRect(0,0,h.width,h.height);draw_graph(u,graph);J=true;t=0;break;default:u.clearRect(0,0,h.width,h.height);draw_graph(u,graph);t=0;}break;case 5:switch(O){case 3:b=B(P),l=b[0],k=b[1];
editor.add_node(l,k);u.clearRect(0,0,h.width,h.height);draw_graph(u,graph);J=true;t=0;break;case 2:a=B(P),l=a[0],k=a[1];R=l-z.x;Q=k-z.y;R*=R;Q*=Q;if((R>4)||(Q>4)){t=0;
}break;default:t=0;}}if(f!==t){console.log(O+": "+f+"->"+t);if(0===t){if(J){C(graph);J=false;}}}return null;};A=function(){var b,a;h=document.getElementById("myCanvas");
h.focus();u=h.getContext("2d");u.fillStyle="gray";u.lineWidth=1.2;u.strokeStyle="rgba(0,0,255,0.5)";u.font="12pt Tahoma";u.textAlign="left";h.addEventListener("mousedown",d,false);
h.addEventListener("mouseup",i,false);h.addEventListener("mousemove",j,false);h.addEventListener("keypress",H,false);h.addEventListener("keyup",D,false);
if(!w(graph)){b=editor.add_node(-50+h.width/2,h.height/2);a=editor.add_node(50+h.width/2,h.height/2);editor.add_edge(b,a);editor.add_edge(a,a);}draw_graph(u,graph);
return null;};B=function(a){var b;b=h.getBoundingClientRect();return[a.clientX-b.left,a.clientY-b.top];};window.onload=function(){A();return null;};d=function(a){K(1,a);
return null;};j=function(a){K(2,a);document.getElementById("debug").innerHTML="x, y = "+B(a);return null;};i=function(a){K(3,a);return null;};H=function(a){if(a.ctrlKey){switch(a.keyCode){case 25:editor.redo();
u.clearRect(0,0,h.width,h.height);draw_graph(u,graph);C(graph);break;case 26:editor.undo();u.clearRect(0,0,h.width,h.height);draw_graph(u,graph);C(graph);
}}return null;};D=function(a){switch(a.keyCode){case 46:editor.del_node(graph.nodes.x.length-1);u.clearRect(0,0,h.width,h.height);draw_graph(u,graph);C(graph);
break;case 81:editor.del_edge(graph.edges.length-1);u.clearRect(0,0,h.width,h.height);draw_graph(u,graph);break;}return null;};this.add=function(b,a){switch(arguments.length){case 2:console.log([b,a]);
break;case 1:console.log([b]);break;default:console.log("wrong arguments: ",arguments);}return this;};(function(){return add();})();add(1);(c=function(){console.log(".");
return setTimeout(c,1000);})();I=[];m={name:"Banny"};I.push(m);F=[];F.push(m);console.log(I[I.length-1]);console.log(F[F.length-1]);m.name="Fred";console.log(I[I.length-1]);
console.log(F[F.length-1]);n={start:0,edges:{a:[0,1],b:[1,1]}};s={edges:{out:function(y,a){var N,v,M,b,L;v=[];console.log(y.get);L=s.get(y);for(M=0,b=L.length;
M<b;M++){N=L[M];console.log(N);}return[];}},get:function(x){var v,b,L,a,y;b=[];y=x.edges.a;for(v=L=0,a=y.length;L<a;v=++L){I=y[v];b.push([I,x.edges.b[v]]);
}return b;},list:function(y){var v,b,x,a;b=[];for(x=0,a=y.length;x<a;x++){v=y[x];console.log(v);b.push(v);}return b;}};(function(){var P,v,x,a,N,M,G,y,O,b,L;
N=M=[n.start];while(N.length){I=N.pop();L=P=s.edges.out(n,I);for(G=0,O=L.length;G<O;G++){x=L[G];F=n.edges.b[e];if(g.call(M,F)<0){v=n.edges[e].v;M.push(F);
N.push(F);}}}for(var a in s){console.log(a);}return null;})();}).call(this);